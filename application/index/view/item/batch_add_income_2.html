<!--<div class="alert alert-info">-->
<!--<a class="close" data-dismiss="alert" href="#">x</a>-->
<!--<h4 class="alert-heading">Information</h4>-->
<!--This template shows how forms can be laid out for editing content.-->
<!--</div>-->

<!--<div class="alert alert-error">-->
<!--<a class="close" data-dismiss="alert" href="#">x</a>-->
<!--<h4 class="alert-heading">Error</h4>-->
<!--Example of an error message alert.-->
<!--</div>-->

<!--<div class="alert alert-success">-->
<!--<a class="close" data-dismiss="alert" href="#">x</a>-->
<!--<h4 class="alert-heading">Success</h4>-->
<!--Example of an success message alert.-->
<!--</div>-->

<!--<div class="alert alert-warning">-->
<!--<a class="close" data-dismiss="alert" href="#">x</a>-->
<!--<h4 class="alert-heading">Warning</h4>-->
<!--Example of an warning message alert.-->
<!--</div>-->
<style>
    input::-webkit-input-placeholder{
        color:red;
    }
    input::-moz-placeholder{   /* Mozilla Firefox 19+ */
        color:red;
    }
    input:-moz-placeholder{    /* Mozilla Firefox 4 to 18 */
        color:red;
    }
    input:-ms-input-placeholder{  /* Internet Explorer 10-11 */
        color:red;
    }
    table th {
     text-align: center; 
     font-weight:bold;
     color:black 
    }
    .no-border {
        border: 1px solid transparent !important;  
    }
    .no-border-left {  
    border-left: 1px solid transparent !important;  
    }  
    .no-border-right {  
    border-right: 1px solid transparent !important;  
    }  
    .no-border-top {  
    border-top: 1px solid transparent !important;  
    }  
    .no-border-bottom {  
    border-bottom: 1px solid transparent !important;  
    }  
    table{
        table-layout:fixed;
    }

</style>
<div class="row">
    <div class="span12">
        <div class="">
            <div class="page-header">
                <h2>{$breadcrumb}
                        <a href="{:url('income')}" class="btn btn-info pull-right">入库记录处理</a>                   
                </h2>
            </div>
            <form class="form-horizontal" method="post" id="form" action="{:url('batchAddIncomeSave')}">
                <div class="table-responsive">
                    <table class="table  text-nowrap table-bordered">
                        <!-- <caption>边框表格布局</caption> -->
                        <thead>
                        <tr class="">
                            <th class="span1 ">进货日期</th>
                            <th class="span1">
                                <input class="input-medium" type="text"  id="date"  name="date" value="" autocomplete="off" >
                            </th>
                            <th class="span1 no-border-right no-border-bottom"></th>
                            <th class="span1 no-border-right no-border-left no-border-bottom"></th>
                            <th class="span1">进货渠道</th>
                            <th class="span1">
                                <select id="channel_id"  name="channel_id" class="input-medium" >
                                    {foreach $channels as $channel}
                                        <option value="{$channel.id}">{$channel.data}</option>
                                    {/foreach}
                                </select>
                            </th>
                        </tr>
                        <tr class="something ">
                            <th class="no-border-right"></th>
                            <th class="no-border-right no-border-left"></th>
                            <th class="no-border-right no-border-left"></th>
                            <th class="no-border-right no-border-left"></th>
                            <th class="no-border-right no-border-left"></th>
                            <th class="no-border-right no-border-left"></th>
                        </tr>
                        <tr class="something ">
                            <th class="">型号</th>
                            <th class="">名称</th>
                            <th class="">网络模式</th>
                            <th class="">配置</th>
                            <th class="">外观</th>
                            <th class="">固件版本</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="type_id" name="type_id" class="input-medium"  value="" data-href="{:url('changeType')}" placeholder="型号不能为空"><span id="type_message" style="color: brown"></span>
                                <input type="hidden"  id="type_status" value="0" />
                            </td>
                            <td>
                                <input type="hidden" name="category_id" id="category_id">
                                <select id="name_id" name="name_id" class="input-medium" >
                                    {foreach $names as $name}
                                        <option value="{$name.id}"  data-category-id="{$name.category_id}" data-appearance="
                                        {foreach $name.itemAppearance as $appearance}
                                            </option>
                                            <option value='{$appearance.id}'>{$appearance.data}</option>
                                        {/foreach}"  data-edition="
                                        {foreach $name.itemEdition as $edition}
                                            </option>
                                            <option value='{$edition.id}'>{$edition.data}</option>
                                        {/foreach}"  data-feature="
                                        {foreach $name.itemFeature as $feature}
                                            </option>
                                            <option value='{$feature.id}'>{$feature.data}</option>
                                        {/foreach}"
                                        data-network="
                                        {foreach $name.itemNetwork as $network}
                                            </option>
                                            <option value='{$network.id}'>{$network.data}</option>
                                        {/foreach}"
                                    
                                        >{$name.data}</option>
                                    {/foreach}
                                </select>
                            </td>
                            <td>
                                <select id="network_id" name="network_id" class="input-medium" >
                                </select>
                            </td>
                            <td>
                                <select id="feature_id" name="feature_id" class="input-medium" >
                                </select>
                            </td>
                            <td>
                                <select id="appearance_id" name="appearance_id" class="input-medium" >
                                </select>
                            </td>
                            <td>
                                <select id="edition_id" name="edition_id" class="input-medium" >
                                </select>
                            </td>
                        </tr>
                        <tr class="something ">
                            <th class="no-border-right"></th>
                            <th class="no-border-right no-border-left  no-border-bottom"></th>
                            <th class="no-border-right no-border-left  no-border-bottom"></th>
                            <th class="no-border-right no-border-left  no-border-bottom"></th>
                            <th class="no-border-right no-border-left  no-border-bottom"></th>
                            <th class="no-border-right no-border-left  no-border-bottom"></th>
                        </tr>
                        <!-- <tr class="something "><th colspan="6" class="no-border-right no-border-top  no-border-bottom" >123123</th></tr> -->
                        <tr class="something ">
                            <th class="no-border-right no-border-top "></th>
                            <th class="no-border-right no-border-top no-border-left"></th>
                            <th class="no-border-right no-border-top no-border-left"></th>
                            <th class="no-border-right no-border-top no-border-left"></th>
                            <th class="no-border-right no-border-top no-border-left"></th>
                            <th class="no-border-right no-border-top no-border-left"></th>
                        </tr>
                        <tr class="something ">
                            <th class="">序号</th>
                            <th class="">序列号</th>
                            <th class="">价格</th>
                            <th class="">备注</th>
                            <th class="" colspan="2" >提示<button type="button" id="add_row" class="btn btn-primary pull-right">增加一行</button></th>
                        </tr>
                        </thead>
                        <!-- <caption></caption> -->
                        <tbody id="table-body">
                        </tbody>
                    </table>
                    <div class="control-group">
                        <label class="control-label" for="submit"></label>
                        <button class="btn btn-success pull-right" type="button" id="submit">确认入库</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="data-all" style="display: none">
    {foreach $names as $name}
        <option value="{$name.id}" data-category-id="{$name.category_id}" data-appearance="
        {foreach $name.itemAppearance as $appearance}
            <option value='{$appearance.id}'>{$appearance.data}</option>
        {/foreach}"  data-edition="
        {foreach $name.itemEdition as $edition}
            <option value='{$edition.id}'>{$edition.data}</option>
        {/foreach}"  data-feature="
        {foreach $name.itemFeature as $feature}
            <option value='{$feature.id}'>{$feature.data}</option>
        {/foreach}"
        data-network="
        {foreach $name.itemNetwork as $network}
            <option value='{$network.id}'>{$network.data}</option>
        {/foreach}"
        >{$name.data}</option>
    {/foreach}
</div>
<span id='item-id' style="display: none" data-id = ""></span>
<script src="/static/js/jquery-1.8.3.js"></script>
<script>
    var arr_data = [
    ]
    var row_data = {"number":"", "price":"", "memo":"", "number_status":"0", "number_message":"序列号不能为空"}

    function changeNameSelected(){

        var category_id = $("#name_id option:selected").data("category-id");
        $("#category_id").val(category_id);

        var appearance_str = $("#name_id option:selected").data("appearance");
        $("#appearance_id").html(appearance_str)

        var edition_str = $("#name_id option:selected").data("edition");
        $("#edition_id").html(edition_str)

        var feature_str = $("#name_id option:selected").data("feature");
        $("#feature_id").html(feature_str)

        var network_str = $("#name_id option:selected").data("network");
        $("#network_id").html(network_str)
    }

    function changeTypeValue(){

        var type = $("#type_id").val();
        var url = $("#type_id").data('href');

        if (type == '') {

            var str = $("#data-all").html();
            $("#name_id").html(str);
            changeNameSelected();
            $("#name_id").removeAttr("readonly");
            $("#name_id").removeAttr("onmousedown");
            $("#network_id").removeAttr("readonly");
            $("#network_id").removeAttr("onmousedown");
            $("#type_message").html('')
            $("#type_status").val(0)
        } else {
            $.get(url, {type:type}, function(res) {
           
                if (res.code  == 500) {
                    alert(res.data);
                    $("#type_message").html(res.data)
                    $("#type_status").val(0)
                }  else {

                    var str = '';
                    $.each(res.data, function(k, v){

                        str += '<option value="'+v.itemName.id+'" data-category-id="'+v.itemName.category_id+'" data-appearance="';
                        $.each(v.itemName.itemAppearance, function (kk, vv){
                            str += "<option value='"+vv.id+"'>"+vv.data+"</option>";
                        })
                        str += '" data-edition="';
                        $.each(v.itemName.itemEdition, function (kk, vv){
                            str += "<option value='"+vv.id+"'>"+vv.data+"</option>";
                        })
                        str += '" data-feature="';
                        $.each(v.itemName.itemFeature, function (kk, vv){
                            str += "<option value='"+vv.id+"'>"+vv.data+"</option>";
                        })
                        str += '" data-network="';
                        str += "<option value='"+v.itemNetwork.id+"'>"+v.itemNetwork.data+"</option>";
                        str += '">'+v.itemName.data+'</option>';
                    });
                        
                    $("#name_id").html(str);
                    changeNameSelected();
                    $("#type_message").html('')
                    $("#type_status").val(1)
                }

                $("#name_id").attr("readonly","readonly");
                $("#name_id").attr("onmousedown","return false;");
                $("#network_id").attr("readonly","readonly");
                $("#network_id").attr("onmousedown","return false;");
            })      
        }
        
    }

    function changeNumber(obj){
        var val = $(obj).val();
        var url = $(obj).data('href');
        var row_num = $(obj).data('row');

        if (val == '') {

            $("#number_status-"+row_num).val(0);
            $("#number_message-"+row_num).html('序列号不能为空');
        } else {
            let err_msg = '';

            //判断页面上是否重复了
            $("#table-body").children().each(function(k, v) {
                let temp_row_num = $(v).data('row');
                if($("#number-" + temp_row_num).val() == val && temp_row_num != row_num) {
                    err_msg += '和序号' + temp_row_num + '行重复;';
                }
            })

            //判断数据库是否重复
            $.get(url, {number: val, id: 0}, function(res){
                if (res.code != 200 && res.code != 222) {
                    err_msg += res.data + ';'; 
                }else if (res.code == 222) {
                    var type_id = $("#type_id").val();
                    var name_id = $("#name_id option:selected").val();
                    var network_id = $("#network_id option:selected").val();
                    var feature_id = $("#feature_id option:selected").val();
                    var appearance_id = $("#appearance_id option:selected").val();
                    // console.log(type_id,name_id,network_id,feature_id,appearance_id);
                    if (res.data.type != type_id || res.data.name_id != name_id || res.data.network_id != network_id || res.data.feature_id != feature_id || res.data.appearance_id != appearance_id) {
                        err_msg += '产品属性可能错误';
                    }
                }

                if (err_msg != '') {
                    $("#number_status-"+row_num).val(0);
                    $("#number_message-"+row_num).html(err_msg);
                } else {
                    $("#number_status-"+row_num).val(1);
                    $("#number_message-"+row_num).html('');
                }
            })
        }
    }

    function addRow(){

        arr_data = [];

        $("#table-body").children().each(function(k, v) {
            row_num = $(v).data('row')
            
            temp_data = {
                "number": $("#number-" + row_num).val(),
                "price": $("#price-" + row_num).val(),
                "memo": $("#memo-" + row_num).val(),
                "number_status": $("#number_status-" + row_num).val(),
                "number_message": $("#number_message-" + row_num).html(),
            }
            arr_data.push(temp_data)
        })

        arr_data.push(row_data);

        var body_str = '';

        for (var i = 0; i < arr_data.length; i++) {
            
            body_str += '<tr id="row-' + (i+1) + '" data-row="' + (i+1) + '">';
            body_str += '<td>' + (i+1) + '</td>';
            body_str += '<td>';
            body_str += '<input type="text" id="number-' + (i+1) + '" data-row="' + (i+1) + '" name="number[' + (i+1) + ']" class="number input-medium" value="' + arr_data[i].number +'"  data-href="checkNumber" data-href2="checkIntelligence">';
            body_str += '<input type="hidden" id="number_status-' + (i+1) + '" value="' + arr_data[i].number_status + '"/>';
            body_str += '</td>';
            body_str += '<td>';
            body_str += '<input type="text" id="price-' + (i+1) + '" name="price[' + (i+1) + ']" class="price input-medium" value="' + arr_data[i].price + '">';
            body_str += '</td>';
            body_str += '<td>';    
            body_str += '<textarea name="memo[' + (i+1) + ']" id="memo-' + (i+1) + '" class="memo input-medium" rows="1">' + arr_data[i].memo + '</textarea>';    
            body_str += '</td>';       
            body_str += '<td  colspan="2"><span id="number_message-' + (i+1) + '" style="color: red">' + arr_data[i].number_message + '</span></td>';       
            body_str += '</tr>';     
        }
        $("#table-body").html(body_str);

        $(".number").on("change",function(){
            changeNumber(this);
        });
    }

    $(function () {
        addRow();

        $("#add_row").click(function(){
            addRow();
        }) 
            

        $("#name_id").change(function () {
            changeNameSelected();
        });

        $("#type_id").change(function(){
            changeTypeValue();
        })


        changeNameSelected();
       
        $.datepicker.regional['zh-CN'] = {
            closeText: '关闭',
            prevText: '<上月',
            nextText: '下月>',
            currentText: '今天',
            monthNames: ['一月', '二月', '三月', '四月', '五月', '六月',
                '七月', '八月', '九月', '十月', '十一月', '十二月'],
            monthNamesShort: ['一', '二', '三', '四', '五', '六',
                '七', '八', '九', '十', '十一', '十二'],
            dayNames: ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'],
            dayNamesShort: ['周日', '周一', '周二', '周三', '周四', '周五', '周六'],
            dayNamesMin: ['日', '一', '二', '三', '四', '五', '六'],
            weekHeader: '周',
            dateFormat: 'yy-mm-dd',
            firstDay: 1,
            isRTL: false,
            showMonthAfterYear: true,
            yearSuffix: '年'
        };

        $.datepicker.setDefaults( $.datepicker.regional[ "zh-CN" ] );

        $("#date").datepicker({
            dateFormat: "yy-mm-dd",
            todayHighlight: false,
            minDate: "-2D",
            maxDate: "+0D"
        });

        $('#date').datepicker("setDate", '+0D');


        $("#submit").click(function(){

            let type_status = $("#type_status").val();
            let err_str = '';
            if (type_status != 1) {
                err_str += '型号错误;\r\n';
            }

            //判断页面上状态
            $("#table-body").children().each(function(k, v) {
                let temp_row_num = $(v).data('row');
                changeNumber($("#number-"+temp_row_num));
                if ($("#number_status-" + temp_row_num).val() != 1) {
                    err_str += '序号【' + temp_row_num + '】,msg：' + $("#number_message-" + temp_row_num).html() + '\r\n';
                }
            })
            // console.log(type_status);
            if (err_str == '') {
                $.post($("#form").attr("action"), $('#form').serialize(), function(res) {
                    var str = '';

                    if (res.code == 200) {
                        str += '成功' + res.data.success.length + '件\r\n';
                        str += '失败' + res.data.field.length + '件\r\n';
                        if (res.data.field.length > 0) {
                            str += '失败信息：\r\n';
                            $.each(res.data.field, function(k, v) {
                                str += '     序号【' + v.index + '】，' + v.msg + '\r\n';
                            });
                        }
                        alert(str);
                    } else {
                        alert('未知错误');
                    }
                })
            } else {
                alert(err_str);
                return false;
            }
        })
    })
</script>